@if (!isLoading){
  <grid-main>
    <app-page-subtitle [subtitle]="'Edit Task'"></app-page-subtitle>

    <form [formGroup]="updateForm">
      <input-text title="ID" formControlName="taskId"></input-text>

      <div formGroupName="updateData" fxLayout="row wrap" fxLayoutAlign="start center" fxLayoutGap="10px">
        <input-text title="Name" formControlName="taskName"></input-text>
        <input-color title="Color" formControlName="color"></input-color>
      </div>

      <div formGroupName="updateData" fxLayoutGap="10px">
        <input-text-area title="Attack command" formControlName="attackCmd"></input-text-area>
        <input-text-area title="Notes" formControlName="notes"></input-text-area>
      </div>

      <div formGroupName="updateData" fxLayout="row wrap" fxLayoutAlign="start center" fxLayoutGap="10px">
        <input-number title="Priority" formControlName="priority"></input-number>
        <input-number title="Status timer" formControlName="statusTimer"></input-number>
        <input-number title="Max agents" formControlName="maxAgents"></input-number>
        <input-number title="Chunk size" formControlName="chunkTime"></input-number>
        <input-check title="CPU only" formControlName="isCpuTask"></input-check>
        <input-check title="Small task" formControlName="isSmall"></input-check>
      </div>

      @if (roleService.hasRole("edit")) {
        <grid-buttons>
          <button-submit name="Purge" (click)="purgeTask()"></button-submit>
          <button-submit name="Update" (click)="onSubmit()"></button-submit>

          @if (isUpdatingLoading) {
            <div>
              <mat-spinner diameter="24" color="accent"></mat-spinner>
            </div>
          }
        </grid-buttons>
      }
    </form>

    <!-- Task Information -->
    <mat-accordion>
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>
            <span><b>Task Information</b></span>
          </mat-panel-title>
        </mat-expansion-panel-header>

        <form [formGroup]="updateForm"
              fxLayout="row wrap"
              fxLayoutAlign="start center"
              fxLayoutGap="10px">

          <input-text title="No. of Chunks" formControlName="chunkSize"></input-text>
          <input-text title="Enforce Piping" formControlName="forcePipe"></input-text>
          <input-text title="Skipping keyspace" formControlName="skipKeyspace"></input-text>
          <input-text title="Keyspace size" formControlName="keyspace"></input-text>
          <input-text title="Keyspace dispatched" formControlName="keyspaceProgress"></input-text>

          @if ( tkeyspace > 0 || (tusepreprocessor && cprogress > 0)) {
            <simulate-form-field label="Keyspace Searched" message="{{ searched }}"></simulate-form-field>
          } @else {
            <simulate-form-field label="Keyspace Searched" message="N/A"></simulate-form-field>
          }

          <!-- Calculations -->
          @if (roleService.hasRole("editTaskChunks")) {

            @if (ctimespent) {
              <simulate-form-field
                  label="Time spent"
                  message="{{ ctimespent | sectotime }}">
              </simulate-form-field>
            } @else {
              <simulate-form-field label="Time spent" message="---"></simulate-form-field>
            }

            @if ( estimatedTime !== 0) {
              <simulate-form-field label="E.T."
                                   message="{{ estimatedTime | sectotime }}">
              </simulate-form-field>
            } @else {
              <simulate-form-field label="E.T." message="---"></simulate-form-field>
            }

            @if (currenspeed !== 0) {
              <simulate-form-field label="Speed"
                                   message="{{ currenspeed | hashRate }}">
              </simulate-form-field>
            } @else {
              <simulate-form-field label="Speed" message="---"></simulate-form-field>
            }
          }

          <!-- Hashlist and Cracker Information -->
          @if(roleService.hasRole("editTaskInfoHashlist")) {
            @if (hashlistinform) {
              <simulate-form-field
                [label]="hashlistinform?.format === 0 ? 'Hashlist' : hashlistinform?.format === 3 ? 'SuperHashlist' : 'Hashlist not found'"
                message="{{ hashlistinform?.name }} / {{ hashlistDescrip }}"
                [routerLink]="'/hashlists/hashlist/'+hashlistinform?.id+'/edit'">
              </simulate-form-field>
            } @else {
              <simulate-form-field label="Hashlist" message="---"></simulate-form-field>
            }
          }

          @if (roleService.hasRole("editTaskInfoCracker")) {
            @if (crackerinfo) {
              <simulate-form-field label="Cracker Information"
                                   message="{{ crackerinfo['binaryName'] }} - {{ crackerinfo['version'] }}"
                                   [routerLink]="'/config/engine/crackers/'+crackerinfo['id']+'/edit'">
              </simulate-form-field>
            } @else {
              <simulate-form-field label="Cracker Information" message="---"></simulate-form-field>
            }
          }

        </form>
      </mat-expansion-panel>

      @if (roleService.hasRole('editTaskFiles')) {
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <span><b>Files</b></span>
            </mat-panel-title>
          </mat-expansion-panel-header>

          <app-tasks-files-table
            #table
            name="filesTable"
            [isSelectable]="false"
            [editIndex]="editedTaskIndex"
            [editType]="0">
          </app-tasks-files-table>
        </mat-expansion-panel>
      }
    </mat-accordion>
  </grid-main>

  <!-- Graph Visual  -->
  @if (tkeyspace > 0) {
    <div class="card shadow">
      <div class="card-body table-responsive" style="overflow-x: auto;">
        <app-page-subtitle [subtitle]="'Visual Graph'"></app-page-subtitle>

        <img
          [hidden]="!taskProgressImageUrl"
          [src]="taskProgressImageUrl"
          alt="Task progress image"
          style="max-width: 100%; height: auto;" />

        <mat-card style="margin-top: 20px">
          <mat-card-content class="info-message justify-content-center">
            <h4 style="margin-top: 0;">Description</h4>
            <table>
              <tr>
                <td style="background-color: #00ff00; width: 20px"></td>
                <td style="padding-left: 10px;">At least one password was retrieved in the chunk</td>
              </tr>
              <tr>
                <td style="background-color: #ffff00;"></td>
                <td style="padding-left: 10px;">No password retrieval in the chunk</td>
              </tr>
              <tr>
                <td style="border: 2px solid #ff0000; background: transparent; color: #ff0000; width: 20px"></td>
                <td style="padding-left: 10px;">Red outline: An error occurred in the chunk</td>
              </tr>
            </table>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  }

  <!-- Assigned Agents -->
  @if (editedTaskIndex && roleService.hasRole("editTaskAgents")) {
    <app-table>
      <app-page-subtitle subtitle="Assigned agents"></app-page-subtitle>

      @if (roleService.hasRole("editTaskAssignAgents")) {
        <form [formGroup]="createForm">
          <mat-form-field>
            <mat-label>Assign Agents</mat-label>
            <mat-select formControlName="agentId">
              @for (aval of availAgents; track aval) {
                <mat-option [value]="aval.id">
                  {{ aval.agentName }}
                </mat-option>
              }
            </mat-select>

            @if (availAgents.length === 0) {
              <mat-hint>No agents available</mat-hint>
            }

            @if (availAgents.length > 0) {
              <mat-hint>{{ availAgents.length }} agent(s) available</mat-hint>
            }

            <!-- Add button -->
            <button (click)="assignAgent()"
                    [attr.aria-label]="'Assign new Agent'"
                    [disabled]="!createForm.get('agentId')?.value"
                    mat-icon-button
                    matSuffix>
              <mat-icon>add</mat-icon>
            </button>

            <!-- Reload button -->
            <button mat-icon-button
                    matSuffix
                    (click)="reloadAgentAssignment()"
                    [attr.aria-label]="'Reload Table'">
              <mat-icon>autorenew</mat-icon>
            </button>
          </mat-form-field>
        </form>
      }

      <tasks-agents-table
        #assignedAgentsTable
        name="assignedAgentsTable"
        datatype="agents-assign"
        [taskId]="editedTaskIndex"
        [assignAgents]="true"
        (assignedAgentsChanged)="reloadAgentAssignment()">
      </tasks-agents-table>

    </app-table>
  }

  <!-- Task speed -->
  @if (roleService.hasRole("editTaskSpeed")) {
    <app-table>
      <app-page-subtitle [subtitle]="'Task Speed'"></app-page-subtitle>
      <app-task-speed-graph [speeds]="originalValue?.speeds"></app-task-speed-graph>
    </app-table>
  }

  <!-- Dispatched Chunks -->
  @if (roleService.hasRole("editTaskChunks")) {
    <app-table>
      <app-page-subtitle [subtitle]="'Dispatched chunks'"></app-page-subtitle>

      <mat-button-toggle-group
        style="margin: 0;"
        [(ngModel)]="chunkview"
        (change)="onChunkViewChange($event)"
        appearance="standard"
        exclusive>
        <mat-button-toggle [value]="0">Live Chunks</mat-button-toggle>
        <mat-button-toggle [value]="1">All Chunks</mat-button-toggle>
      </mat-button-toggle-group>

      <br /><br />

      <app-tasks-chunks-table
        [taskId]="editedTaskIndex"
        [isChunksLive]="chunkview">
      </app-tasks-chunks-table>

    </app-table>
  }
}