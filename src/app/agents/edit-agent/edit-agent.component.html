<!-- Spinner Loading -->
<div *ngIf="isLoading" style="text-align: center;">
  <app-loading-spinner></app-loading-spinner>
</div>
<!-- Header -->
<app-page-title [title]="pTitle" [subbutton]="subbutton"></app-page-title>
<!-- Body -->
<grid-main [class]="'width:100%'">
  <form [formGroup]="updateForm" (ngSubmit)="onSubmit()">
    <div class="row g-3">
      <div class="col-md-2">
        <grid-form-input [name]="'Agent ID'">
          <div class="input-group">
            <span class="pre input-group-text input-group-lg">
              <td>
                {{ showagent['agentId'] }}
              </td>
            </span>
          </div>
        </grid-form-input>
      </div>
      <div class="col-md-10">
        <grid-form-input [name]="'Last activity'">
          <span class="input-group-text input-group-lg w-60 mx-auto">
            <td>
              Time: {{ showagent['lastTime']*1000 | date: uidateformat }}<br>
              Action: {{ showagent['lastAct'] }}<br>
              IP: <code>{{ showagent['lastIp'] }}</code>
            </td>
          </span>
        </grid-form-input>
      </div>
    </div>
    <ngb-accordion #acc="ngbAccordion" >
      <ngb-panel>
        <ng-template ngbPanelTitle>
          <span><b>Show/Hide details</b></span>
        </ng-template>
        <ng-template ngbPanelContent>
          <grid-form-input [name]="'Owner'" [labelclass]="'display-col'">
            <div class="input-group">
              <span class="input-group-text">
                <fa-icon [icon]="faIdBadge" aria-hidden="true"></fa-icon>
              </span>
              <select
                      type='number'
                      id="userId"
                      class='form-select'
                      formControlName="userId"
              >
              <option *ngFor="let u of users" [ngValue]="u.userId">{{ u.username }}</option>
              </select>
            </div>
          </grid-form-input>
          <grid-form-input [name]="'Machine Name'" [labelclass]="'display-col'">
            <div class="input-group">
              <span class="input-group-text">
                <fa-icon [icon]="faComputer" aria-hidden="true"></fa-icon>
              </span>
              <input
                    type='text'
                    id="agentName"
                    class='form-control'
                    formControlName="agentName"
              >
            </div>
          </grid-form-input>
          <hr>
          <div class="row g-3">
            <div class="col-md-2">
              <grid-form-input [name]="'CPU only'" [labelclass]="'display-col'">
                <td>
                  <select
                        id="cpuOnly"
                        class='form-select'
                        formControlName="cpuOnly"
                    >
                    <option [ngValue]="false">No</option>
                    <option [ngValue]="true">Yes</option>
                  </select>
              </grid-form-input>
            </div>
            <div class="col-md-2">
              <grid-form-input [name]="'Trust'" [labelclass]="'display-col'" [tooltip]="'Trust agent with secret data'">
                <select
                      id="isTrusted"
                      class='form-select'
                      formControlName="isTrusted"
                    >
                    <option [ngValue]="false">No</option>
                    <option [ngValue]="true">Yes</option>
                </select>
              </grid-form-input>
            </div>
            <div class="col-md-8">
              <grid-form-input [name]="'Assignment'" [labelclass]="'display-col'">
                <select
                      type='text'
                      id="assignment"
                      class='form-select'
                    >
                    <option>Missing</option>
                </select>
              </grid-form-input>
            </div>
          </div>
          <grid-form-input [name]="'Member of access groups'" [labelclass]="'display-col'">
            <input
                  type='number'
                  id="accessgroups"
                  class='form-control'
            >
          </grid-form-input>
          <grid-form-input [name]="'Extra parameters'" [labelclass]="'display-col'">
            <input
                  type='text'
                  id="cmdPars"
                  class='form-control'
                  formControlName="cmdPars"
            >
          </grid-form-input>
          <grid-form-input [name]="'Cracker errors'" [labelclass]="'display-col'">
            <select
                  type='text'
                  id="ignoreErrors"
                  class='form-select'
                  formControlName="ignoreErrors"
              >
              <option value="NO">Deactivate agent on error</option>
              <option value="IGNORE_SAVE">Keep agent running, but save errors</option>
              <option value="IGNORE_NOSAVE">Keep agent running and discard errors</option>
            </select>
          </grid-form-input>
          <hr>
          <h4 class="display-col">Agent Detailed Information</h4>
          <div class="row">
            <div class="col">
              <grid-form-input [name]="'Machine ID'" [labelclass]="'display-col'">
                <span class="pre input-group-text input-group-lg w-70 mx-auto">
                  <td>
                    {{ showagent['uid'] }}
                  </td>
                </span>
              </grid-form-input>
              </div>
              <div class="col">
                <grid-form-input [name]="'Access token'" [labelclass]="'display-col'">
                  <div class="input-group">
                    <span class="input-group-text">
                      <fa-icon [icon]="faKey" aria-hidden="true"></fa-icon>
                    </span>
                    <input
                          type='text'
                          id="token"
                          class='form-control'
                          formControlName="token"
                    >
                  </div>
                </grid-form-input>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-md-2">
              <grid-form-input [name]="'O.S.'" [labelclass]="'display-col'">
                <div class="input-group">
                  <span *ngIf="showagent['os'] == 0" class="input-group-text input-group-lg w-15 mx-auto">
                    <fa-icon [icon]="faLinux" aria-hidden="true"></fa-icon>Linux
                  </span>
                  <span *ngIf="showagent['os'] == 1" class="input-group-text input-group-lg w-15 mx-auto">
                    <fa-icon [icon]="faWindows" aria-hidden="true"></fa-icon>Windows
                  </span>
                  <span *ngIf="showagent['os'] == 2" class="input-group-text input-group-lg w-15 mx-auto">
                    <fa-icon [icon]="faApple" aria-hidden="true"></fa-icon>IOS
                  </span>
                </div>
              </grid-form-input>
            </div>
            <div class="col-md-10">
              <grid-form-input [name]="'Graphic cards'" [labelclass]="'display-col'">
                <span class="pre input-group-text input-group-lg w-70 mx-auto">
                  <td>
                    {{ showagent['devices'] }}
                  </td>
                </span>
              </grid-form-input>
            </div>
          </div>
          <grid-form-input [name]="'Time spent cracking'" [labelclass]="'display-col'">
            <span class="pre input-group-text input-group-lg">
              <td>
                <div  *ngIf="timespent">
                  {{ timespent | sectotime }}
                </div>
              </td>
            </span>
          </grid-form-input>
        </ng-template>
      </ngb-panel>
    </ngb-accordion>
    &nbsp;
    <grid-form-input [name]="'Active'" [labelclass]="'display-col'">
      <div class="form-check">
        <input
              type="checkbox"
              id="isActive"
              class="form-check-input"
              value=""
              formControlName="isActive"
        >
      </div>
    </grid-form-input>
    <button-submit [name]="'Update'"></button-submit>
  </form>
</grid-main>
<!-- Errors -->
<!-- <p>Missing API for Agent Error Factory?</p> -->

<!-- Dispatched Chunks -->
<app-page-subtitle [subtitle]="'Dispatched chunks'"></app-page-subtitle>
<h5>Latest 50 chunks</h5>
<div class="table-responsive">
  <table class="table table-striped table-hover table-sm" datatable [dtOptions]="dtOptions[1]" [dtTrigger]="dtTrigger">
    <thead class="thead-light">
      <tr>
        <th class="rounded-start">ID</th>
        <th>Start</th>
        <th>Length</th>
        <th>Checkpoint</th>
        <th>Progress</th>
        <th>Task</th>
        <th>Dispatch time</th>
        <th>Last activity</th>
        <th>Time spent</th>
        <th>State</th>
        <th class="rounded-end">Cracked</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let gc of getchunks">
        <td>{{ gc.chunkId }}</td>
        <td>{{ gc.skip }}</td>
        <td>{{ gc.length }}</td>
        <td>{{ gc.checkpoint }} ({{ (gc.checkpoint-gc.skip)/gc.length | percent }})</td>
        <td *ngIf="gc.progress > 0">{{ gc.progress/100 }} %</td>
        <td *ngIf="!gc.progress">N/A</td>
        <td>
          {{ gc.taskName | shortenString:15 | lowercase | titlecase}}
          <a class='btn-outline-gray-600 float-right' [routerLink]="['/tasks/show-tasks',gc.taskId,'edit']" title="View Task">
            <fa-icon [icon]="faEye" aria-hidden="true"></fa-icon>
          </a>
        </td>
        <td>{{ gc.dispatchTime*1000 | date: uidateformat }}</td>
        <td *ngIf="gc.solveTime === 0">(No acitivity)</td>
        <td *ngIf="gc.solveTime > 0"> {{ gc.solveTime*1000 | date: uidateformat }} </td>
        <td>{{ (gc.solveTime - gc.dispatchTime) | sectotime }}</td>
        <td>{{ gc.state | staticArray:'states' }}</td>
        <td>
          {{ gc.cracked }}
          <a class='btn-outline-gray-600 float-right' [routerLink]="['/hashlists/hashes/','tasks',gc.taskId]" title="Show Hashes">
            <fa-icon [icon]="faEye" aria-hidden="true"></fa-icon>
          </a>
        </td>
      </tr>
    </tbody>
  </table>
</div>


